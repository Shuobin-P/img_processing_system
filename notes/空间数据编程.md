Geoprocessing is a general term for manipulating spatial data, whether raster or vector.

# 空间数据

## Vector data
Vector data is made up of points, lines, and polygons. A dataset containing country boundaries is an example of vector data. In this case, each country is generally represented as a polygon.

正如一张图片可以用png,jpeg,tif等格式进行存储，vector data也有很多不同的存储文件格式，比如：ShapeFile,GeoJSON。

Shapefiles are a popular format for storing vector data. A shapefile isn’t made of a single file, however. In fact, this format requires a minimum of three binary files, each of which serves a different purpose. Geometry information is stored in .shp and .shx files, and attribute values are stored in a .dbf file. Additionally, other data, such as indexes or spatial reference information, can be stored in even more files. Generally you don’t need to know anything about these files, but you do need to make sure that they’re all kept together in the same folder.

### OGR
The OGR Simple Features Library is part of the Geospatial Data Abstraction Library (GDAL). The OGR portion of GDAL is the part that provides the ability to read and write many different vector data formats. OGR also allows you to create and manipulate geometries; edit attribute values; filter vector data based on attribute values or spatial location; and it also offers data analysis capabilities

![](https://cdn.jsdelivr.net/gh/1907-peng/pictures/img/RemoteSensingDigitalImageProcessing-OGR.png)

Data source: 例如：shapefile, GeoJSON这些不同的vector data文件格式。This data source can have one or more child Layer objects, one for each dataset contained in the data source. Many vector data formats, such as the shapefile examples used in this chapter, can only contain one dataset. Regardless of how many datasets are in a data source, each one is considered a layer by OGR. 

![](https://cdn.jsdelivr.net/gh/1907-peng/pictures/img/RemoteSensingDigitalImageProcessing-Attribute_Table.png)
每个feature代表一个地理对象。

## Raster Data
raster data is a two or three dimensional array of data values such as the pixels in a photograph.

Raster datasets are well suited to any continuous data, not only photographs. Precipitation data like that shown in figure 1.6 is a good example. Rain doesn’t usually stop at a sudden boundary, so it’s hard to draw a polygon around it. Instead, a grid of pre-
cipitation amounts works much better and can capture local variation more easily.

![](https://cdn.jsdelivr.net/gh/1907-peng/pictures/img/RemoteSensingDigitalImageProcessing-Raster_data_use_case.jpg)


A raster dataset is made of bands, and each of these bands is a two-dimensional array. The collection of bands becomes a 3D array.


# Using spatial reference systems
A spatial reference system is made of three components—a datum[^4], and a projection, a coordinate system[^3]—all of which affect where on the earth a set of coordinates refers to. Briefly, datums are used to represent the curvature of the earth, and projections transform coordinates from a three-dimensional globe to a two-dimensional map. Differ ent projections are appropriate for dif ferent purposes, such as web mapping, accurately measuring distances, or calculating areas.

因为地球表面有山或者峡谷，所以地球不完全是一个球体，and also because measurement accuracies vary, the earth’s ellipsoid(椭球) has multiple models. These models are called datums, and every spatial reference system is based on one of them. One widely used global datum, the World Geodetic System, was last revised in 1984. This datum, called WGS84 for short, is the one used for data with a global coverage, including the Global Positioning System (GPS). <u>Most datums are designed to model the curvature of the earth in a more localized area</u>, such as a continent or even a smaller area. 
A datum designed for one area will not work well elsewhere. For example, the North American Datum of 1983 (NAD83) shouldn’t be used in Europe.

Depending on which datum is being used, the same set of latitude and longitude coordinates can refer to slightly different locations, because the underlying ellipsoids are different shapes. Sometimes the difference between coordinates using two different datums is negligible, but other times it can be hundreds of meters. 


通过三维的地球得到二维的地图的办法：One way to solve the problem is with what’s called an interrupted map.
![](https://cdn.jsdelivr.net/gh/1907-peng/pictures/img/RemoteSensingDigitalImageProcessing-An_interrupted_Map.jpg)

解决各个洲被分割成块，以及被浪费的空间分离的办法——projection。This is where projections come in. As their name implies, they’re used to project, or transform, locational data into a different coordinate system.

No matter how you project geographic data to two dimensions, you’ll get distortion.
Figure 8.3 shows a couple of ways a piece of paper could be wrapped around a globe and used to convert the geographic data to 2D.
![RemoteSensingDigitalImageProcessing-Projection.jpg](https://cdn.jsdelivr.net/gh/1907-peng/pictures/img/RemoteSensingDigitalImageProcessing-Projection.jpg)

Certain projections, called conformal, preserve local shapes. For example, the shape of Lake Titicaca on the border of Bolivia and Peru wouldn’t change between the globe and the 2D map. Others, called equal-area projections, keep the amount of area the same, so the measured area of Greenland wouldn’t change, although the shape might. The Lambert equal-area and Gall-Peters projections are two examples of this.

![RemoteSensingDigitalImageProcessing-Examples_of_different_types_of_projection.jpg](https://cdn.jsdelivr.net/gh/1907-peng/pictures/img/RemoteSensingDigitalImageProcessing-Examples_of_different_types_of_projection.jpg)


## Spatial reference objects
To work with a spatial reference system, you need a SpatialReference object that represents it.


# 读写raster data
## 介绍
As mentioned, raster datasets can hold pretty much any type of data you’d like. That doesn’t mean that it’s always a good idea to use rasters, however. Objects that can be thought of as points, lines, or polygons are usually better left as vectors. For example, country boundaries lend themselves perfectly to a polygon vector dataset. This same data could be stored in a raster, but it would take up more disk space and the boundaries wouldn’t be nice, smooth lines. 

Raster is a perfect choice when values change continuously instead of at sharply defined boundaries. This includes common datasets such as elevation, slope, aspect, precipitation, temperature, and satellite data. 

Now let’s talk a bit about the details of raster datasets. You can probably envision a digital photograph as a two-dimensional array of pixels. In fact, that’s what we talk about when discussing the dimensions of a photo—the numbers of rows and columns in that 2D array. This is what raster datasets are, except that they aren’t limited to two dimensions. They can have a third dimension in the form of bands. Digital photos have multiple bands, too, although you don’t usually think of them that way. But they have one each for red, green, and blue wavelengths of light. Your computer (or printer) combines these together to produce the colors you see on your monitor
screen. 

Obviously not all raster datasets are photographs, so pixel values don’t have to correspond to colors. Pixel values in a digital elevation model (DEM), for example, correspond to elevation values.

Raster datasets commonly use one set of coordinates, the pixel size, and the amount the dataset is rotated <u>to determine coordinates for the rest of the image</u>. This is called an affine transformation, and is a common way to georeference a raster dataset, although it isn’t
the only way.

If rasters can be so large and take a while to process, how can they be drawn on your screen in a reasonable amount of time? This is where overview layers come in. You might have also heard them called pyramid layers or reduced resolution datasets.  Overview layers are reduced resolution layers—they’re rasters that cover the same area as the original, but are resampled to larger pixel sizes. 

![](https://cdn.jsdelivr.net/gh/1907-peng/pictures/img/RemoteSensingDigitalImageProcessing-Overview_Layers.jpg)
A raster dataset can have many different overviews, each with a different resolution. When you’re zoomed out and looking at the whole image, the coarse resolution layer is drawn. Because the pixels are so large, that layer doesn’t take much memory and can draw quickly, but you can’t tell the difference at that zoom level. As you zoom in, a higher resolution layer is drawn, but only the part you’re viewing needs to be loaded and shown. If you zoom in enough, you’ll see the original pixels, but because you’re only looking at a small subset of the image, it still draws quickly.

Incidentally, the ubiquitous web-mapping services use this same technique to display aerial photography, except that the reduced resolution layers are stored as collections of individual tiles. Your browser downloads whichever tiles are required to cover the area you’re looking at, and as you zoom in, you get tiles that have a higher resolution and cover a smaller area, until eventually the resolution is so good that you can see your house or car.


You’re probably also wondering about data compression, because this is regularly used with digital photos in .jpeg format and can significantly reduce the size of a file.  You might have heard of lossy versus lossless compression. Lossy compression loses information in the act of compressing the data. When saving .jpegs, you’ve probably noticed the compression quality option. The higher the quality, the less data you lose and the better the resulting image looks. The .png format, however, is lossless, which is why you aren’t asked for a compression quality when saving one of
those. That doesn’t mean that the data can’t be compressed. It means that you won’t lose any data in the act of compression, and the image can be perfectly reconstructed into the original uncompressed dataset.
If you plan to compress your data but you also need to perform analyses on it, make sure you select a lossless algorithm. Otherwise, your analysis won’t be operating on the actual pixel values because several will have been lost. GeoTIFF is a popular lossless format.

I have one more important concept you need to understand if you’re going to use raster data, and that’s the difference between resampling methods. You don’t have a one-to-one mapping between pixels when a raster is resampled to a different cell size or reprojected to another spatial reference system, so new pixel values have to be calculated. The simplest and fastest method, called nearest-neighbor, is to use the value from the old pixel that’s closest to the new one.  Another possible algorithm, shown in figure 9.5, is to take the average of the four closest pixels.

![RemoteSensingDigitalImageProcessing-Resampling_Method_example.jpg](https://cdn.jsdelivr.net/gh/1907-peng/pictures/img/RemoteSensingDigitalImageProcessing-Resampling_Method_example.jpg)


![RemoteSensingDigitalImageProcessing-Landcover_Classification_Map.png](https://cdn.jsdelivr.net/gh/1907-peng/pictures/img/RemoteSensingDigitalImageProcessing-Landcover_Classification_Map.png)

在处理包含离散值的数据集时（例如图 9.1 中的土地覆盖分类），你应始终使用最近邻重采样方法。否则，可能会得到一个不属于任何分类的数值，或者一个表示完全不相关的分类数值。另一方面，对于连续数据，则更适合使用其他重采样方法。例如，取平均海拔值是完全合理的做法，并且相比使用最近邻[^1]方法，这样可以获得更平滑的输出结果。



## GDAL介绍
Numerous different file formats exist for raster data, and GDAL is an extremely popular and robust library for reading and writing many of them. 
![](https://cdn.jsdelivr.net/gh/1907-peng/pictures/img/RemoteSensingDigitalImageProcessing-GDAL_Dataset_structure.jpg)
注意：对一个dataset的写操作结束之后，记得`del 该dataset`，否则图片不能被打开。

Each dataset contains one or more bands, which in turn contain the pixel data and possibly overviews. The georeferencing information is contained in the dataset because all of the bands use the same infor-
mation for this.

The geotransform is important because it provides the origin coordinates[^2] and pixel sizes, along with rotation values if the image isn’t situated so the top faces north.

![](https://cdn.jsdelivr.net/gh/1907-peng/pictures/img/RemoteSensingDigitalImageProcessing-Geotransform_Items.jpg)

## 重采样
### RESAMPLING TO SMALLER PIXELS
![RemoteSensingDigitalImageProcessing-Resampling_to_smaller_pixels.jpg](https://cdn.jsdelivr.net/gh/1907-peng/pictures/img/RemoteSensingDigitalImageProcessing-Resampling_to_smaller_pixels.jpg)


### RESAMPLING TO LARGER PIXELS
![](https://cdn.jsdelivr.net/gh/1907-peng/pictures/img/RemoteSensingDigitalImageProcessing-RESAMPLING_to_LARGER_PIXELS.jpg)

Although this technique usually uses nearest-neighbor interpolation to resample, if you have an overview layer of the requested resolution, then that will be used instead. If the appropriate overview was built with average interpolation, then that’s what you’d get when using ReadAsArray, rather than nearest-neighbor.



## Subdatasets
Several types of datasets can contain other datasets, which each in turn contain bands (figure 9.15). One example of this is the MODIS imagery distributed by the United States Geological Service, which comes as a hierarchical data format (HDF) file. If your dataset contains subdatasets, you can get a list of them with the GetSubDatasets function and then use that information to open the one you want.
![](https://cdn.jsdelivr.net/gh/1907-peng/pictures/img/RemoteSensingDigitalImageProcessing-Subdatasets.jpg)

## 镶嵌
```python
import glob
import os
from osgeo import gdal
import math

  

# 获得x，y的坐标最小值，最大值；即清楚了图像的长和宽。

def get_extent(fn):

    '''Returns min_x, max_y, max_x, min_y'''

    ds = gdal.Open(fn)

    gt = ds.GetGeoTransform()

    # ds.RasterXSize 指照片的长有多少像素点，ds.RasterYSize是照片的宽有多少像素点

    return (gt[0], gt[3], gt[0] + gt[1] * ds.RasterXSize, gt[3] + gt[5] * ds.RasterYSize)

  

os.chdir(r'E:\Tools\QGIS_tutorial_data\osgeopy-data\Massachusetts')

  

# Calculate output extent from all inputs

in_files = glob.glob('O*.tif') # 以O开头的所有tif文件

min_x, max_y, max_x, min_y = get_extent(in_files[0])

  

for fn in in_files[1:]:

    minx, maxy, maxx, miny = get_extent(fn)

    min_x = min(min_x, minx)

    max_y = max(max_y, maxy)

    max_x = max(max_x, maxx)

    min_y = min(min_y, miny)

  

# Calculate dimensions

in_ds = gdal.Open(in_files[0])

gt = in_ds.GetGeoTransform()

rows = math.ceil((max_y - min_y) / -gt[5])

columns = math.ceil((max_x - min_x) / gt[1])

  

# Create output

driver = gdal.GetDriverByName('gtiff')

out_ds = driver.Create('mosaic.tif', columns, rows)

print("columns = ", columns)

print("rows = ", rows)

out_ds.SetProjection(in_ds.GetProjection())

out_band = out_ds.GetRasterBand(1)

  

# Calculate new geotransform

gt = list(in_ds.GetGeoTransform())

gt[0], gt[3] = min_x, max_y

out_ds.SetGeoTransform(gt)

  

for fn in in_files:

    in_ds = gdal.Open(fn)

    # Get output offsets

    trans = gdal.Transformer(in_ds, out_ds, [])

    success, xyz = trans.TransformPoint(False, 0, 0)

    x, y, z = map(int, xyz)

    # Copy data

    data = in_ds.GetRasterBand(1).ReadAsArray()

    out_band.WriteArray(data, x, y)

  
del in_ds, out_band, out_ds

```
One other thing to be aware of is that if the input rasters overlap, then pixel values in the overlap area will be overwritten by
the last raster that covers the overlap. Or you could implement a fancier algorithm to average the pixel values or handle them in another way.

## 裁剪
遥感影像裁剪的目的是将研究之外的区域去除，裁剪方式分为：规则裁剪（矩形范围）和不规则裁剪（任意多边形）。


# Working with raster data
如果现在有一张旧照片，然后你扫描得到一张电子照片，但它不会附加任何地理信息。All is not lost, however, as long as you know what area the photo is of and can identify a few locations. These locations are called ground control points (GCPs), which are points for which you know the real-world coordinates.
If you can associate a number of pixels around the image with actual coordinates, then the image can be warped to overlay on a map, as shown in figure 10.2.
![](https://cdn.jsdelivr.net/gh/1907-peng/pictures/img/RemoteSensingDigitalImageProcessing-Ground_Control_Points.jpg)

## color tables
In thematic rasters the pixel values **represent a classification** such as vegetation type instead of color information like in a photograph. If you want to control how these datasets are displayed, then you need a color table.

```python
colors = gdal.ColorTable()                                              
colors.SetColorEntry(1, (112, 153, 89))
```
The first parameter to SetColorEntry is the pixel value that you want to set the color for, and the second parameter is a tuple or list containing the red, green, and blue values for the color.
```python
band.SetRasterColorTable(colors)                                    
```
然后将该color table交给band。

对于已有的color table也可以进行修改：
```python
# 将像素值为5的颜色修改为白色
os.chdir(r'D:\Projects\VsCode\Python\img_processing_system\osgeopy-data\Switzerland')

ds = gdal.Open('dem_class2.tif', gdal.GA_Update)              

band = ds.GetRasterBand(1)

colors = band.GetRasterColorTable()

colors.SetColorEntry(5, (250, 250, 250))

band.SetRasterColorTable(colors)                                  

del band, ds
```
# 地图分类
One common use for raster data is map classification, which involves categorizing the pixels into groups.

## 非监督式分类
In unsupervised classification, it first groups pixels into “clusters” based on their properties. Then, you classify each cluster with a land cover class.
![](https://cdn.jsdelivr.net/gh/1907-peng/pictures/img/RemoteSensingDigitalImageProcessing-Unsupervised_classification.png)


## 监督式分类
### 精度评估


## 基于对象分类

The object-based approach groups neighboring pixels together based on how similar they are in a process known as segmentation. Segmentation takes into account color and the shape characteristics when deciding how pixels are grouped.

OBIA的过程：
- **SEGMENTATION**: segmentation is a process that groups similar pixels into objects.![](https://cdn.jsdelivr.net/gh/1907-peng/pictures/img/RemoteSensingDigitalImageProcessing-OBIA_Segmentation.jpg)Each segment represents an object. Objects represent buildings, roads, trees, fields or pieces of those features, depending on how the segmentation is done.
- **CLASSIFICATION**: Classify those objects using their shape, size, spatial and spectral properties.![](https://cdn.jsdelivr.net/gh/1907-peng/pictures/img/RemoteSensingDigitalImageProcessing-OBIA_Classification-Final.jpg)



[^1]: 即输出raster数据中格子的取值是输入raster数据中与其最近的格子的值。
[^2]: 是指图像左上角原点的地理坐标 X 值和地理坐标 Y 值。
[^3]: 即如何用数字表示一个地点
[^4]: 表示地球的形状。How do we model the Earth’s surface